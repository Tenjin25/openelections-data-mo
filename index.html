<!DOCTYPE html>
<html>
<head>
  <script>
    // Load FIPS-to-county-name mapping from mo_county_fips.csv
    let fipsToCountyName = {};
    async function loadFipsToCountyName() {
      const resp = await fetch('Data/mo_county_fips.csv');
      const text = await resp.text();
      text.split(/\r?\n/).forEach((line, idx) => {
        if (idx === 0) return; // skip header
        const [fips, name] = line.split(',');
        if (fips && name) fipsToCountyName[fips.trim()] = name.trim();
      });
    }
  </script>
  <style>
    .spinner svg {
      vertical-align: middle;
    }
    @keyframes spinner-rotate {
      to { transform: rotate(360deg); }
    }
    .spinner svg circle {
      animation: spinner-rotate 0.8s linear infinite;
    }
  </style>
  <!-- Removed candidate_lookup.csv and dynamic candidate name logic. Use normalized candidate names from JSON only. -->
  <script>
    // Helper: get candidate name from JSON data only
    function getCandidateName(year, office, party) {
      // This function can be customized if you want to add static overrides
      return party;
    }
  </script>
  <script>
    // Zoom to county by name using turf.js
    function zoomToCounty(countyName) {
      const countiesSource = map.getSource('counties');
      if (!countiesSource || !countiesSource._data || !countiesSource._data.features) return;
      const counties = countiesSource._data.features;
        // Unified robust normalization for all county name lookups
        function normalizeCountyName(name) {
          return (name || '')
            .replace(/^saint /i, 'st ')
            .replace(/^st\.? /i, 'st ')
            .replace(/\bsaint\b/gi, 'st')
            .replace(/\bst\.?\b/gi, 'st')
            .replace(/[^a-z0-9 ]/gi, '')
            .replace(/\s+/g, ' ')
            .trim()
            .toUpperCase();
        }
      const normTarget = normalizeCountyName(countyName);
      const countyFeature = counties.find(f => {
        const props = f.properties || {};
        const name = normalizeCountyName(props.County || props.COUNTYNAME || props.NAME || '');
        return name === normTarget;
      });
      if (!countyFeature) return;
      const bbox = turf.bbox(countyFeature);
      map.fitBounds(bbox, { padding: 40, maxZoom: 10 });
    }
  </script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <meta charset='utf-8'>
  <title>MO Political Realignment Map (2000-2024)</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>
  <meta property="og:title" content="MO Political Realignment Map (2000-2024)">
  <meta property="og:description" content="Interactive visualization of Missouri's political trends from 2000 to 2024, showing county-level voting patterns.">
  <meta property="og:image" content="preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet'>
    <style>
/* Show floating button only when sidebar is minimized */
#sidebar-float-toggle { display: none; }
.sidebar.minimized ~ #sidebar-float-toggle { display: flex !important; }
html, body {
  height: 100vh;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  height: 100vh;
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  overflow: hidden;
}
#map {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw !important;
  height: 100vh;
  background: #f0f4f8;
  transition: left 0.3s cubic-bezier(.4,0,.2,1), width 0.3s cubic-bezier(.4,0,.2,1);
  z-index: 1;
}
#sidebar {
  position: absolute;
  top: 0;
  right: 0;
  height: 100vh;
  z-index: 2;
}
#map.sidebar-minimized {
  left: 0;
  width: 100vw !important;
}

/* Hover Tooltip */
.hover-tooltip {
  position: absolute;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
  z-index: 1000;
  max-width: 300px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  display: none;
  line-height: 1.4;
}

.hover-tooltip .tooltip-title {
  font-weight: bold;
  margin-bottom: 8px;
  color: #ffffff;
  border-bottom: 1px solid #444;
  padding-bottom: 6px;
}

.hover-tooltip .tooltip-trends {
  font-family: monospace;
  font-size: 12px;
}

.quick-tooltip {
  background: rgba(40, 40, 40, 0.95);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  line-height: 1.3;
}

.quick-tooltip strong {
  color: #fff;
  font-weight: 600;
}

.sidebar {
  width: 400px;
  height: 100vh;
  background: #fff;
  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
  border-left: 1px solid #e5e7eb;
  overflow-y: auto;
  transition: width 0.3s cubic-bezier(.4,0,.2,1);
}
.sidebar.minimized {
  width: 0 !important;
  min-width: 0 !important;
  max-width: 0 !important;
  overflow: hidden !important;
  pointer-events: none;
  border: none !important;
  box-shadow: none !important;
  background: transparent !important;
  padding: 0 !important;
  margin: 0 !important;
}
.sidebar.minimized .sidebar-content {
  display: none !important;
}
.sidebar.minimized .sidebar-header {
  display: none !important;
}
.sidebar.minimized .minimize-btn {
  display: flex !important;
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: #2563eb;
  color: white;
  border: 1px solid #1d4ed8;
}
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}
.sidebar-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}
.sidebar-content {
  padding: 20px;
}
.minimize-btn {
  background: #2563eb;
  border: 1px solid #1d4ed8;
  border-radius: 6px;
  width: 30px;
  height: 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  color: white;
  transition: all 0.2s ease;
}
.minimize-btn:hover {
  background: #1d4ed8;
  border-color: #1e40af;
  transform: scale(1.05);
}

/* Main Controls */
.main-controls {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  z-index: 1000;
  min-width: 380px;
  max-width: 420px;
  transition: all 0.3s ease;
}
.main-controls.minimized {
  min-width: 60px;
  max-width: 60px;
  padding: 15px;
}
.main-controls.minimized .controls-content {
  display: none;
}
.controls-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.controls-header h3 {
  margin: 0;
  color: #1f2937;
  font-weight: 600;
  font-size: 16px;
}
.controls-content {
  position: relative;
}
.analysis-mode {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.mode-toggle {
  flex: 1;
  padding: 8px;
  text-align: center;
  border: 2px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
  font-weight: 500;
}
.mode-toggle.active {
  background: #3498db;
  color: white;
  border-color: #3498db;
}
.analysis-mode {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  background: #f3f4f6;
  border-radius: 8px;
  padding: 4px;
}
.mode-toggle {
  flex: 1;
  text-align: center;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  color: #6b7280;
}
.mode-toggle.active {
  background: #2563eb;
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
}
.mode-toggle:hover:not(.active) {
  background: #e5e7eb;
  color: #374151;
}
.view-toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  background: #f3f4f6;
  border-radius: 8px;
  padding: 4px;
}
.control-group {
  margin-bottom: 16px;
}
.control-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #374151;
}
.control-group select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  font-size: 14px;
}

/* Legend */
.legend {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  z-index: 1000;
  min-width: 250px;
  border: 1px solid #e5e7eb;
}
.legend.minimized .legend-content {
  display: none;
}
.legend-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
  border-radius: 12px 12px 0 0;
}
.legend-header h4 {
  margin: 0;
  font-size: 1rem;
  color: #374151;
}
.legend-content {
  padding: 16px 20px;
}
.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
}
.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 3px;
  margin-right: 10px;
  flex-shrink: 0;
}
/* County Details */
.county-details {
  margin-bottom: 20px;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.county-details h4 {
  margin: 0 0 12px 0;
  color: #374151;
  font-size: 16px;
  font-weight: 700;
}
/* Sidebar Card Classes for Consistent Font Sizes */
.sidebar-section-title {
  font-size: 14px !important;
  font-weight: 700 !important;
  margin-bottom: 6px !important;
  color: #222 !important;
}
.sidebar-winner {
  font-size: 14px !important;
  font-weight: 700 !important;
  margin-bottom: 8px !important;
}
.sidebar-margin {
  font-size: 14px !important;
  font-weight: 700 !important;
  margin-bottom: 4px !important;
}
.sidebar-margin-details {
  font-size: 13px !important;
  color: #64748b !important;
  margin-bottom: 8px !important;
}
.sidebar-breakdown {
  font-size: 14px !important;
  font-weight: 600 !important;
  margin-bottom: 2px !important;
}
.statewide-results {
  margin-bottom: 20px;
  padding: 16px;
  background: #f0f9ff;
  border-radius: 8px;
  border: 1px solid #0ea5e9;
}
.statewide-results h4 {
  margin: 0 0 15px 0;
  font-size: 16px !important;
  font-weight: 700 !important;
  color: #1f2937 !important;
}

/* Statewide Results */
.statewide-results {
  border-top: 1px solid #e5e7eb;
  padding-top: 20px;
  margin-bottom: 20px;
}
.statewide-results h4 {
  margin: 0 0 15px 0;
  color: #1f2937;
  font-size: 16px;
  font-weight: 600;
}
.statewide-margin {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
}
.margin-text {
  font-weight: 600 !important;
  font-size: 14px !important;
}
.margin-details {
  font-size: 14px !important;
  color: #64748b !important;
  margin-top: 5px !important;
}

.findings-section {
  margin-bottom: 20px;
}
.findings-section h4 {
  margin: 0 0 16px 0;
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
}
.finding-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.finding-card h5 {
  margin: 0 0 12px 0;
  color: #1f2937;
  font-size: 14px;
  font-weight: 600;
  border-bottom: 2px solid #3b82f6;
  padding-bottom: 6px;
}
.finding-card p {
  margin: 8px 0;
  font-size: 13px;
  line-height: 1.5;
  color: #374151;
}
.metric {
  background: #dbeafe;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #1e40af;
}

/* End of styles */

.metric {
  background: #eff6ff;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 600;
  color: #1d4ed8;
  display: inline-block;
  margin: 2px;
}

/* Status panel */
.status-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  border: 1px solid #e5e7eb;
  z-index: 1000;
  max-width: 300px;
}
    .sidebar.minimized .sidebar-footer {
      display: none !important;
    }
    #sidebar-float-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      width: 40px;
      height: 40px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      font-size: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sidebar-float-toggle:hover {
      background: #1746a0;
    }
    .sidebar.minimized ~ #sidebar-float-toggle {
      display: flex !important;
    }
  /* Removed empty ruleset for #map.sidebar-minimized */
    </style>
</head>
  <body>
<div id="map"></div>
  <!-- Sidebar for County Details and Analysis (single instance only) -->
    <div class="sidebar minimized" id="sidebar">
      <div class="sidebar-header" id="sidebar-header">
        <h3>üìä County Analysis</h3>
        <button class="minimize-btn" onclick="toggleSidebar()" id="sidebar-minimize-btn">+</button>
      </div>
      <div class="sidebar-content">
        <div class="county-details" id="county-details" style="display: none;">
          <h4 id="county-name">Select a County</h4>
          <div id="county-info-content">
            Click on any county to see detailed election results and analysis.
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label for="county-search" style="font-weight:600;">Search County:</label>
          <input type="text" id="county-search" placeholder="Type to search..." style="width:100%;padding:8px;border-radius:6px;margin-top:6px;margin-bottom:6px;border:1px solid #d1d5db;" />
        </div>
        <div class="statewide-results" id="statewide-results">
          <h4 id="statewide">üèõÔ∏è Missouri Statewide</h4>
          <div id="statewide-content">
           <p>Select a contest to see statewide results and margin.</p>
           <div id="statewide-temperature-bar" style="width:100%;height:24px;margin:12px 0;display:none;"></div>
          </div>
        </div>
      </div>
      <div class="sidebar-footer" style="padding: 16px 0; text-align: center; color: #888; font-size: 15px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
        Created by Shamar Davis
      </div>
    </div>
  <!-- Floating Sidebar Expand/Collapse Button (smaller size) -->
  <button id="sidebar-float-toggle" title="Expand Sidebar">+</button>

  <!-- Floating Status Panel -->
  <div class="status-panel" id="status-panel" style="display:none;position:fixed;top:20px;right:90px;z-index:10002;background:rgba(255,255,255,0.97);backdrop-filter:blur(10px);padding:18px 24px 18px 18px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.12);border:1px solid #e5e7eb;max-width:340px;min-width:200px;font-size:15px;color:#34495e;">
    <span id="status-message"></span>
    <button id="status-exit" title="Close" style="position:absolute;top:10px;right:10px;padding:4px 10px;border-radius:6px;border:none;background:#eee;cursor:pointer;font-weight:bold;font-size:18px;">√ó</button>
  </div>
    


    <!-- Main Controls Dropdown (Contest Selector) -->
  <div class="main-controls" id="main-controls">
    <div class="controls-header">
      <h3>üó≥Ô∏è MO Political Contests</h3>
      <button class="minimize-btn" onclick="toggleMainControls()" id="controls-minimize-btn">‚àí</button>
    </div>
    <div class="controls-content" id="controls-content">
      <div class="analysis-mode">
        <div class="mode-toggle active" id="county-mode">County Results</div>
      </div>
      <div class="control-group">
        <label>üó∫Ô∏è Map View:</label>
        <div class="view-toggle">
          <div class="mode-toggle active" id="counties-view">Counties</div>
        </div>
      </div>
      <div class="control-group">
        <label>üìä Contest Type:</label>
        <select id="contestSelect">
          <option value="">Select a Contest...</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Duplicate sidebar removed to fix HTML errors -->

    <!-- Legend -->
    <div class="legend" id="legend">
        <div class="legend-header">
            <h4>Political Categories</h4>
            <button class="minimize-btn" onclick="toggleLegend()" id="legend-minimize-btn">‚àí</button>
        </div>
        <div class="legend-content" id="legend-content">
            <div class="legend-item"><div class="legend-color" style="background: #67000d;"></div>Annihilation Republican (40%+)</div>
            <div class="legend-item"><div class="legend-color" style="background: #a50f15;"></div>Dominant Republican (30-40%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #cb181d;"></div>Stronghold Republican (20-30%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #ef3b2c;"></div>Safe Republican (10-20%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #fb6a4a;"></div>Likely Republican (5.5-10%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #fcae91;"></div>Lean Republican (1-5.5%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #fee8c8;"></div>Tilt Republican (0.5-1%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #f7f7f7; border: 1px solid #999;"></div>Tossup (¬±0.5%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #e1f5fe;"></div>Tilt Democratic (0.5-1%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #c6dbef;"></div>Lean Democratic (1-5.5%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #9ecae1;"></div>Likely Democratic (5.5-10%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #6baed6;"></div>Safe Democratic (10-20%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #3182bd;"></div>Stronghold Democratic (20-30%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #08519c;"></div>Dominant Democratic (30-40%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #08306b;"></div>Annihilation Democratic (40%+)</div>
        </div>
    </div>



    <script>
    // --- CONFIG ---
    const CONFIG = {
      mapboxToken: 'pk.eyJ1Ijoic2hhbWFyZGF2aXMiLCJhIjoiY21kcW8yeDB2MDhvbTJzb29qeGp1aDZmZCJ9.Zw_i6U-dL7_bEKRHTUh7yg',
      paths: {
          counties: 'VTDs/tl_2020_29_county20.geojson',
        election: './VTDs/tl_2020_29_vtd20/mo_county_aggregated_results.json'
      },
      center: [-92.5, 38.5],
      zoom: 6.2,
      fitBounds: [[-95.8, 35.9], [-89.1, 40.6]]
    };

    mapboxgl.accessToken = CONFIG.mapboxToken;

    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/light-v11', center: CONFIG.center, zoom: CONFIG.zoom });

  let electionData = null;
  let countyNameMap = {};
  let currentView = 'counties';
  let currentElectionResults = null;


    function setStatus(text, timeout = 4000) {
      const panel = document.getElementById('status-panel');
      const msg = document.getElementById('status-message');
      if (!panel || !msg) return;
      // Only log status messages to the console; do not show the floating status panel
      console.log(text);
    }

    async function loadJSON(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error(`${path} fetch failed: ${r.status}`);
      return r.json();
    }

    // Remove CSV loader, use JSON loader for election data
// ...existing code...

    function buildCountyNameMapFromGeoJSON(geojson) {
      const map = {};
      if (!geojson || !geojson.features) return map;
      function normalizeCountyName(name) {
        return (name || '')
          .replace(/St\.? Lucie/i, 'St Lucie')
          .replace(/St\.? Johns/i, 'St Johns')
          .replace(/[^a-z0-9 ]/gi, '')
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      geojson.features.forEach(f => {
        const p = f.properties || {};
        // For tl_2020_29_vtd20.geojson, county FIPS is p.COUNTYFP20, county name is not directly present.
        // We'll use COUNTYFP20 as the key, and map to county FIPS for lookup.
        if (p.COUNTYFP20) {
          map[p.COUNTYFP20] = p.COUNTYFP20;
        }
      });
      return map;
    }

    function formatContestName(contestType, year) {
      const nameMap = {
        'president': 'President of the United States',
        'governor': 'Governor', 
        'us_senate': 'United States Senator',
        'attorney_general': 'Attorney General',
        'cfo': 'Chief Financial Officer',
        'agriculture_commissioner': 'Commissioner of Agriculture',
        'us_house': 'US House',
        'state_senate': 'State Senate',
        'state_house': 'State House',
        'gov': 'Governor',
        'pre': 'President of the United States', 
        'uss': 'United States Senator',
        'usr': 'US Representative',
        'agr': 'Commissioner of Agriculture',
        'atg': 'Attorney General',
        'cfo': 'Chief Financial Officer',
        'str': 'State Representative',
        'sts': 'State Senator',
        'ctj': 'Circuit Judge',
        'sta': 'State Attorney',
        'pub': 'Public Defender',
        'sc1': 'Supreme Court Justice',
        'sc2': 'Supreme Court Justice',
        'sc3': 'Supreme Court Justice',
        'sc4': 'Supreme Court Justice',
        'sc5': 'Supreme Court Justice'
      };
      
      if (contestType.startsWith('a') && contestType.length <= 3) {
        return `Amendment ${contestType.substring(1).toUpperCase()}`;
      }
      
      if (contestType.startsWith('d')) {
        return `Judicial Retention ${contestType.toUpperCase()}`;
      }
      
      return nameMap[contestType] || contestType.toUpperCase();
    }

    function populateContestSelectFromElectionJSON(electionData) {
  const sel = document.getElementById('contestSelect');
  sel.innerHTML = '<option value="">Select a contest...</option>';
  // New logic: contests are under results_by_year[year][contest]
  const contestYearPairs = [];
  const resultsByYear = electionData.results_by_year || {};
  Object.keys(resultsByYear).forEach(year => {
    const contests = resultsByYear[year] || {};
    Object.keys(contests).forEach(contest => {
      contestYearPairs.push({ contest, year });
    });
  });
  console.log('Contest-year pairs:', contestYearPairs);
  // Sort by year, then contest
  contestYearPairs.sort((a, b) => {
    if (a.year !== b.year) return a.year.localeCompare(b.year);
    return a.contest.localeCompare(b.contest);
  });
  if (contestYearPairs.length === 0) {
    sel.innerHTML = '<option value="">No contests found in data</option>';
    setStatus('No contests found in election data!');
    return;
  }
  contestYearPairs.forEach(({ contest, year }) => {
    const opt = document.createElement('option');
    opt.value = `${contest}_${year}`;
    opt.textContent = `${contest} (${year})`;
    sel.appendChild(opt);
  });
  sel.onchange = () => {
    applyContest(sel.value);
    if (typeof lastSelectedCounty !== 'undefined' && lastSelectedCounty) {
      showCountyDetails(lastSelectedCounty);
    }
  };
    }
    // (Old applyCountyContest removed; see new version further down)

    // Removed setMapView: only county view remains

    // Placeholder function for 2000 VTD layers (will be implemented when data is available)
    function add2000VTDLayers() {
      if (typeof window.vtds2000Data === 'undefined') {
        setStatus('2000 VTD data not loaded. Please load VTD shapefiles and election data.');
        // Switch back to counties view
        setMapView('counties');
        return;
      }
      
      if (!map.getLayer('vtds-2000-fill')) {
        map.addLayer({ 
          id: 'vtds-2000-fill', 
          type: 'fill', 
          source: 'vtds-2000', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.3 } 
        });
        map.addLayer({ 
          id: 'vtds-2000-stroke', 
          type: 'line', 
          source: 'vtds-2000', 
          paint: { 'line-color': '#666', 'line-width': 0.5 } 
        });
        
        // Add click handler for VTDs
        map.on('click', 'vtds-2000-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const vtdProps = e.features[0].properties;
            const vtdId = vtdProps.VTD || vtdProps.VTDST || vtdProps.NAME || 'Unknown';
            
            // Show VTD details
            showVTDDetails(vtdId, vtdProps);
          }
        });
        
        setStatus('2000 VTD layer loaded');
      }
    }
    
    // Function to show VTD details (placeholder)
    function showVTDDetails(vtdId, vtdProps) {
      const detailsDiv = document.getElementById('area-details');
      detailsDiv.innerHTML = `
        <h4>2000 Precinct ${vtdId}</h4>
        <div class="data-row">
          <span class="label">VTD ID:</span>
          <span class="value">${vtdId}</span>
        </div>
        <div class="data-row">
          <span class="label">Properties:</span>
          <span class="value">${Object.keys(vtdProps).length} attributes</span>
        </div>
        <p><em>Election results will be displayed when precinct-level data is loaded.</em></p>
      `;
      detailsDiv.style.display = 'block';
    }

    function toggleLegend() {
      const legend = document.getElementById('legend');
      const legendContent = document.getElementById('legend-content');
      const minimizeBtn = document.getElementById('legend-minimize-btn');
      
      if (legend.classList.contains('minimized')) {
        // Expand legend
        legend.classList.remove('minimized');
        legendContent.style.display = 'block';
        minimizeBtn.textContent = '‚àí';
        minimizeBtn.title = 'Minimize legend';
      } else {
        // Minimize legend
        legend.classList.add('minimized');
        legendContent.style.display = 'none';
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Expand legend';
      }
    }

    function toggleMainControls() {
      const controls = document.getElementById('main-controls');
      const controlsContent = document.getElementById('controls-content');
      const minimizeBtn = document.getElementById('controls-minimize-btn');
      
      if (controls.classList.contains('minimized')) {
        // Expand controls
        controls.classList.remove('minimized');
        controlsContent.style.display = 'block';
        minimizeBtn.textContent = '‚àí';
        minimizeBtn.title = 'Minimize controls';
      } else {
        // Minimize controls
        controls.classList.add('minimized');
        controlsContent.style.display = 'none';
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Expand controls';
      }
    }

    function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const sidebarContent = document.querySelector('.sidebar-content');
  const minimizeBtn = document.getElementById('sidebar-minimize-btn');
  const mapElement = document.getElementById('map');
  const floatBtn = document.getElementById('sidebar-float-toggle');
  if (sidebar.classList.contains('minimized')) {
    // Expand sidebar
    sidebar.classList.remove('minimized');
    mapElement.classList.remove('sidebar-minimized');
    sidebarContent.style.display = 'block';
    minimizeBtn.textContent = '‚àí';
    minimizeBtn.title = 'Minimize sidebar';
    if (floatBtn) floatBtn.style.display = 'none';
  } else {
    // Minimize sidebar
    sidebar.classList.add('minimized');
    mapElement.classList.add('sidebar-minimized');
    sidebarContent.style.display = 'none';
    minimizeBtn.textContent = '+';
    minimizeBtn.title = 'Expand sidebar';
    if (floatBtn) floatBtn.style.display = 'flex';
  }
// ...existing code...

// Floating sidebar button click toggles sidebar open (register only once)
document.addEventListener('DOMContentLoaded', function() {
  var floatBtn = document.getElementById('sidebar-float-toggle');
  if (floatBtn) {
    floatBtn.addEventListener('click', function() {
      toggleSidebar();
    });
  }
});
}

    function showCountyDetails(countyName) {
      // --- NC Map Card-Style Sidebar ---
      const sidebar = document.getElementById('sidebar');
      const detailsDiv = document.getElementById('county-details');
      const contentEl = document.getElementById('county-info-content');
      if (!contentEl || !detailsDiv) return;
      if (sidebar) {
        sidebar.classList.remove('minimized');
        const floatBtn = document.getElementById('sidebar-float-toggle');
        if (floatBtn) floatBtn.style.display = 'none';
        const btn = document.getElementById('sidebar-minimize-btn');
        if (btn) btn.textContent = '‚àí';
      }
      const countyNameElement = document.getElementById('county-name');
      if (countyNameElement) {
        let displayName = (typeof fipsToCountyName !== 'undefined' && fipsToCountyName[countyName]) ? fipsToCountyName[countyName] : countyName;
        // Special case for St. Louis City
        if (displayName.trim().toUpperCase() === 'ST. LOUIS CITY' || displayName.trim().toUpperCase() === 'ST LOUIS CITY') {
          countyNameElement.textContent = 'City of St. Louis';
        } else {
          countyNameElement.textContent = displayName + (displayName.trim().toUpperCase().endsWith('CITY') ? '' : ' County');
        }
      }
      let sidebarContent = '';
      // Guard: election results must exist
      if (!currentElectionResults) {
        contentEl.innerHTML = '<p>Select a contest to see county results.</p>';
        detailsDiv.style.display = 'block';
        return;
      }
      // Normalize and find county data
      function normalizeCountyName(name) {
        return (name || '')
          .replace(/^saint /i, 'st ')
          .replace(/^st\.? /i, 'st ')
          .replace(/\bsaint\b/gi, 'st')
          .replace(/\bst\.?\b/gi, 'st')
          .replace(/[^a-z0-9 ]/gi, '')
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      let norm = normalizeCountyName(countyName);
      let countyData = currentElectionResults[norm];
      if (!countyData) {
        for (const key in currentElectionResults) {
          if (normalizeCountyName(key) === norm) {
            countyData = currentElectionResults[key];
            break;
          }
        }
      }
      if (!countyData) {
        // Debug log for normalization issues
        console.warn('No county data found for:', countyName, '| Normalized:', norm);
        console.warn('Available normalized keys:', Object.keys(currentElectionResults));
        contentEl.innerHTML = '<p>No results found for this county in the selected contest.</p>';
        detailsDiv.style.display = 'block';
        return;
      }
      // Get contest info
      const contestSelect = document.getElementById('contestSelect');
      const contestKey = contestSelect && contestSelect.value;
      if (!contestKey) {
        contentEl.innerHTML = '<p>Select a contest to see detailed results.</p>';
        detailsDiv.style.display = 'block';
        return;
      }
      const lastUnderscoreIndex = contestKey.lastIndexOf('_');
      const contestType = contestKey.substring(0, lastUnderscoreIndex);
      const year = contestKey.substring(lastUnderscoreIndex + 1);
      // Votes
      const demVotes = countyData[`${contestType}_dem`] || 0;
      const repVotes = countyData[`${contestType}_rep`] || 0;
      const totalVotes = countyData[`${contestType}_total`] || 0;
      if (totalVotes === 0) {
        contentEl.innerHTML = `<p>No ${formatContestName(contestType, year)} data available for ${countyName} County in ${year}.</p>`;
        detailsDiv.style.display = 'block';
        return;
      }
      const demPct = (demVotes / totalVotes * 100);
      const repPct = (repVotes / totalVotes * 100);
      // Candidate names
  let demCandidate = getCandidateName(year, formatContestName(contestType, year), 'Democrat');
  let repCandidate = getCandidateName(year, formatContestName(contestType, year), 'Republican');
      // Margin
      const margin = demVotes - repVotes;
      const marginPct = (Math.abs(margin) / totalVotes * 100).toFixed(2);
      const winner = margin > 0 ? 'Democratic' : (margin < 0 ? 'Republican' : 'Tie');
      const winnerCandidate = margin > 0 ? demCandidate : repCandidate;
      const marginText = margin > 0 ? 'D+' + marginPct + '%' : (margin < 0 ? 'R+' + marginPct + '%' : 'Tied');
      const winnerColor = winner === 'Republican' ? '#dc2626' : '#2563eb';
      // Precincts (if available)
      let precincts = '';
      if (countyData.precincts || countyData.Precincts || countyData.PRECINCTS) {
        precincts = countyData.precincts || countyData.Precincts || countyData.PRECINCTS;
      }
      // Card-style layout
  sidebarContent += '<div class="result-summary">';
  sidebarContent += '<h3 class="sidebar-section-title">üìä Election Results</h3>';
      if (precincts) sidebarContent += `<div style="font-size:14px;"><b>Precincts:</b> ${precincts}</div>`;
      sidebarContent += `<div style="font-size:14px;margin-bottom:10px;"><b>Total Votes:</b> ${totalVotes.toLocaleString()}</div>`;
      sidebarContent += `</div>`;
    sidebarContent += `<div class="winner-section">`;
  sidebarContent += '<h3 class="sidebar-section-title">üèÜ Winner</h3>';
  sidebarContent += `<p class="sidebar-winner" style="color: ${winnerColor}; font-weight: bold;">${winnerCandidate} (${winner === 'Republican' ? 'R' : 'D'})</p>`;
    sidebarContent += `</div>`;
    sidebarContent += `<div class="margin-section">`;
  sidebarContent += '<h3 class="sidebar-section-title">üìà Margin</h3>';
  sidebarContent += `<p class="sidebar-margin" style="color: ${winnerColor}; font-weight: bold;">${winner === 'Republican' ? 'R+' : 'D+'}${marginPct}%</p>`;
    sidebarContent += `<p class="sidebar-margin-details" style="color: #6b7280;">(${Math.abs(margin).toLocaleString()} vote margin)</p>`;
    sidebarContent += `</div>`;
    sidebarContent += `<div class="vote-breakdown">`;
  sidebarContent += '<h3 class="sidebar-section-title">üó≥Ô∏è Vote Breakdown</h3>';
  sidebarContent += `<p class="sidebar-breakdown"><span style="color: #2563eb; font-weight: bold;">${demCandidate} (D)</span> : ${demPct.toFixed(2)}% (${demVotes.toLocaleString()})</p>`;
  sidebarContent += `<p class="sidebar-breakdown"><span style="color: #dc2626; font-weight: bold;">${repCandidate} (R)</span> : ${repPct.toFixed(2)}% (${repVotes.toLocaleString()})</p>`;
    sidebarContent += `</div>`;
      // Competitiveness
      let competitiveness;
      const actualMarginPct = parseFloat(marginPct);
      if (actualMarginPct >= 40) {
        competitiveness = winner === 'Republican' ? "Annihilation Republican" : "Annihilation Democratic";
      } else if (actualMarginPct >= 30) {
        competitiveness = winner === 'Republican' ? "Dominant Republican" : "Dominant Democratic";
      } else if (actualMarginPct >= 20) {
        competitiveness = winner === 'Republican' ? "Stronghold Republican" : "Stronghold Democratic";
      } else if (actualMarginPct >= 10) {
        competitiveness = winner === 'Republican' ? "Safe Republican" : "Safe Democratic";
      } else if (actualMarginPct >= 5.5) {
        competitiveness = winner === 'Republican' ? "Likely Republican" : "Likely Democratic";
      } else if (actualMarginPct >= 1) {
        competitiveness = winner === 'Republican' ? "Lean Republican" : "Lean Democratic";
      } else if (actualMarginPct >= 0.5) {
        competitiveness = winner === 'Republican' ? "Tilt Republican" : "Tilt Democratic";
      } else {
        competitiveness = `Tossup (${winner} win)`;
      }
      let compColor = '#6b7280';
      if (competitiveness.includes('Rep')) {
        if (competitiveness.includes('Annihilation')) compColor = '#450a0a';
        else if (competitiveness.includes('Dominant')) compColor = '#7f1d1d';
        else if (competitiveness.includes('Stronghold')) compColor = '#991b1b';
        else if (competitiveness.includes('Safe')) compColor = '#dc2626';
        else if (competitiveness.includes('Likely')) compColor = '#ef4444';
        else if (competitiveness.includes('Lean')) compColor = '#f87171';
        else if (competitiveness.includes('Tilt')) compColor = '#fca5a5';
      } else if (competitiveness.includes('Dem')) {
        if (competitiveness.includes('Annihilation')) compColor = '#0c1d56';
        else if (competitiveness.includes('Dominant')) compColor = '#1e3a8a';
        else if (competitiveness.includes('Stronghold')) compColor = '#1e40af';
        else if (competitiveness.includes('Safe')) compColor = '#3b82f6';
        else if (competitiveness.includes('Likely')) compColor = '#60a5fa';
        else if (competitiveness.includes('Lean')) compColor = '#93c5fd';
        else if (competitiveness.includes('Tilt')) compColor = '#bfdbfe';
      }
      sidebarContent += `<div class="competitiveness-section">`;
      sidebarContent += '<h5>üéØ Competitiveness</h5>';
      sidebarContent += `<p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>`;
      if (actualMarginPct <= 0.5) {
        sidebarContent += `<p style="color: #f59e0b; font-style: italic;">(Extremely close!)</p>`;
      } else if (actualMarginPct <= 1) {
        sidebarContent += `<p style="color: #f59e0b; font-style: italic;">(Very close!)</p>`;
      }
      sidebarContent += `</div>`;
      contentEl.innerHTML = sidebarContent;
      detailsDiv.style.display = 'block';
      detailsDiv.style.display = 'block';
    }

    function addCountyLayers() {
      if (!map.getLayer('county-fill')) {
        map.addLayer({ 
          id: 'county-fill', 
          type: 'fill', 
          source: 'counties', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.38 } 
        });
        map.addLayer({ 
          id: 'county-stroke', 
          type: 'line', 
          source: 'counties', 
          paint: { 'line-color': '#333', 'line-width': 1 } 
        });
        // Add county label layer
        map.addLayer({
          id: 'county-label',
          type: 'symbol',
          source: 'counties',
          layout: {
            // Show 'City of St. Louis' for St. Louis City, else default name
            'text-field': [
              'case',
                [
                  'any',
                  ['==', ['get', 'NAME20'], 'ST LOUIS CITY'],
                  ['==', ['get', 'County'], 'ST LOUIS CITY'],
                  ['==', ['get', 'COUNTYNAME'], 'ST LOUIS CITY'],
                  ['==', ['get', 'NAME'], 'ST LOUIS CITY'],
                  ['==', ['get', 'name'], 'ST LOUIS CITY']
                ],
                'City of St. Louis',
                [
                  'coalesce',
                  ['get', 'NAME20'],
                  ['get', 'County'],
                  ['get', 'COUNTYNAME'],
                  ['get', 'NAME'],
                  ['get', 'name']
                ]
            ],
            'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
            'text-size': 13,
            'text-anchor': 'center',
            'text-offset': [0, 0]
          },
          paint: {
            'text-color': '#374151',
            'text-halo-color': '#fff',
            'text-halo-width': 1.2
          }
        });
        // Add click handler for counties: show sidebar with details
        map.on('click', 'county-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const countyName = e.features[0].properties.County;
            if (countyName) {
              showCountyDetails(countyName);
              lastSelectedCounty = countyName;
              // Expand sidebar if minimized
              const sidebar = document.getElementById('sidebar');
              if (sidebar.classList.contains('minimized')) {
                toggleSidebar();
              }
            }
          }
        });
        map.on('mouseenter', 'county-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'county-fill', () => {
          map.getCanvas().style.cursor = '';
        });
      }
    }

    // Removed addDistrictLayers: no district layers

    // Removed addStateHouseLayers: no state house layers

    // Removed addStateSenatelayers: no state senate layers

    function clearCountyDetails() {
      document.getElementById('county-details').style.display = 'none';
    }


    // Sidebar minimized by default on load, expand on click
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('sidebar-minimize-btn');
  // sidebar.classList.add('minimized');
  // btn.textContent = '+';

      // Populate county search dropdown/list with county names if available
      // Wait for map and counties source to be loaded
      map.on('load', function() {
        const countiesSource = map.getSource('counties');
        if (!countiesSource) return;
        let counties = [];
        if (countiesSource._data && countiesSource._data.features) {
          counties = countiesSource._data.features.map(f => f.properties && (f.properties.County || f.properties.COUNTYNAME || f.properties.NAME)).filter(Boolean).sort();
        }
        const searchInput = document.getElementById('county-search');
        if (searchInput && counties.length > 0) {
          // Create a datalist for autocomplete
          let datalist = document.getElementById('county-datalist');
          if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = 'county-datalist';
            document.body.appendChild(datalist);
            searchInput.setAttribute('list', 'county-datalist');
          }
          datalist.innerHTML = counties.map(name => `<option value="${name}"></option>`).join('');
        }
      });

      // Allow selecting a county by typing and pressing enter
      const searchInput = document.getElementById('county-search');
      if (searchInput) {
        searchInput.addEventListener('change', function() {
          const val = searchInput.value.trim();
          if (val) {
            zoomToCounty(val);
            showCountyDetails(val);
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('minimized')) {
              toggleSidebar();
            }
          }
        });
      }
    });

    function getHistoricalTrends(countyName, isDistrict = false, districtNum = null) {
      const presidentialYears = [2024, 2020, 2016, 2012, 2008];
      const stateHouseYears = [2024, 2022, 2020, 2018, 2016]; // Recent state house elections
      const trends = [];
      
      if (isDistrict && districtNum) {
        // For congressional districts, use congressional data
        presidentialYears.forEach(year => {
          const data = congressionalData.find(row => 
            row.year == year && row.district == districtNum
          );
          
          if (data && data.us_house_total > 0) {
            const demVotes = data.us_house_dem || 0;
            const repVotes = data.us_house_rep || 0;
            const totalVotes = data.us_house_total || 0;
            
            if (totalVotes > 0) {
              const demPct = (demVotes / totalVotes) * 100;
              const repPct = (repVotes / totalVotes) * 100;
              const margin = demPct - repPct;
              const winner = margin > 0 ? 'D' : 'R';
              const marginAbs = Math.abs(margin);
              
              trends.push({
                year: year,
                display: `${year}: ${winner}+${marginAbs.toFixed(1)}`,
                margin: margin,
                type: 'house'
              });
            }
          }
        });

      } else {
        // For counties, show both presidential and recent state house trends
        
        // Presidential trends
        presidentialYears.forEach(year => {
          const data = electionData.find(row => 
      row.year == year && normalizeCountyName(row.county) === normalizeCountyName(countyName)
          );
          
          if (data && data.president_total > 0) {
            const demVotes = data.president_dem || 0;
            const repVotes = data.president_rep || 0;
            const totalVotes = data.president_total || 0;
            
            if (totalVotes > 0) {
              const demPct = (demVotes / totalVotes) * 100;
              const repPct = (repVotes / totalVotes) * 100;
              const margin = demPct - repPct;
              const winner = margin > 0 ? 'D' : 'R';
              const marginAbs = Math.abs(margin);
              
              // Get candidate names for recent years
              let candidateInfo = '';
              if (year === 2024) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2020) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2016) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2012) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2008) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              
              trends.push({
                year: year,
                display: `${year}: ${candidateInfo}+${marginAbs.toFixed(1)}`,
                margin: margin,
                type: 'president'
              });
            }
          }
        });
        
        // Add separator if we have presidential data
        if (trends.length > 0) {
          trends.push({
            year: 0,
            display: '--- State House ---',
            margin: 0,
            type: 'separator'
          });
        }
        
        // State House trends (recent years only)
        // Governor trends (recent years only)
        governorYears.forEach(year => {
          const data = electionData.find(row => 
      row.year == year && normalizeCountyName(row.county) === normalizeCountyName(countyName)
          );
          if (data && data.governor_total > 0) {
            const demVotes = data.governor_dem || 0;
            const repVotes = data.governor_rep || 0;
            const totalVotes = data.governor_total || 0;
            const demPct = (demVotes / totalVotes) * 100;
            const repPct = (repVotes / totalVotes) * 100;
            const margin = demPct - repPct;
            const winner = margin > 0 ? 'D' : 'R';
            const marginAbs = Math.abs(margin);
            let candidateInfo = '';
            candidateInfo = margin > 0 ? getCandidateName(year, 'Governor', 'Democrat') : getCandidateName(year, 'Governor', 'Republican');
            trends.push({
              year: year,
              display: `${year}: ${candidateInfo}+${marginAbs.toFixed(1)}`,
              margin: margin,
              type: 'governor'
            });
          }
        });
        stateHouseYears.forEach(year => {
          const data = electionData.find(row => 
            row.year == year && row.county === countyName
          );
          
          if (data && data.state_house_total > 0) {
            const demVotes = data.state_house_dem || 0;
            const repVotes = data.state_house_rep || 0;
            const totalVotes = data.state_house_total || 0;
            
            if (totalVotes > 0) {
              const demPct = (demVotes / totalVotes) * 100;
              const repPct = (repVotes / totalVotes) * 100;
              const margin = demPct - repPct;
              const winner = margin > 0 ? 'D' : 'R';
              const marginAbs = Math.abs(margin);
              
              trends.push({
                year: year,
                display: `${year}: ${winner}+${marginAbs.toFixed(1)} (House)`,
                margin: margin,
                type: 'state_house'
              });
            }
          }
        });
      }
      
      return trends;
    }

    function formatTooltipContent(title, trends) {
      let trendsHtml = '';
      if (trends.length > 0) {
        trendsHtml = trends.map(t => {
          if (t.type === 'separator') {
            return `<div style="color: #999; font-style: italic; margin: 6px 0; border-top: 1px solid #444; padding-top: 6px;">${t.display}</div>`;
          }
          
          const color = t.margin > 0 ? '#3b82f6' : '#ef4444'; // Blue for Dem, Red for Rep
          return `<div style="color: ${color};">${t.display}</div>`;
        }).join('');
      } else {
        trendsHtml = '<div style="color: #999;">No historical data</div>';
      }
      
      return `
        <div class="tooltip-title">${title}</div>
        <div class="tooltip-trends">${trendsHtml}</div>
      `;
    }

    function showDistrictDetails(districtNum) {
      const detailsDiv = document.getElementById('county-details');
      const nameEl = document.getElementById('county-name');
      const contentEl = document.getElementById('county-info-content');
      
      nameEl.textContent = `Congressional District ${districtNum}`;
      
      // Get district info from districtsInfo CSV
      const districtInfo = districtsInfo.find(d => d.district == districtNum);
      
      let demographicInfo = '';
      if (districtInfo) {
        demographicInfo = `
          <div style="margin-bottom: 16px;">
            <h5>üë• Demographics (VAP)</h5>
            <p><strong>Total Population:</strong> ${districtInfo.total_population.toLocaleString()}</p>
            <p><strong>White:</strong> ${districtInfo.white_vap_pct}%</p>
            <p><strong>Black:</strong> ${districtInfo.black_vap_pct}%</p>
            <p><strong>Hispanic:</strong> ${districtInfo.hispanic_vap_pct}%</p>
          </div>
        `;
      }
      
      // Get current contest results if available
      const contestValue = document.getElementById('contestSelect').value;
      let electionInfo = '';
      
      if (contestValue && congressionalData) {
        const [contestType, year] = contestValue.split('_');
        if (contestType === 'us_house') {
          const result = congressionalData.find(row => 
            row.year == year && row.district == districtNum
          );
          
          if (result && result.us_house_total > 0) {
            const demVotes = result.us_house_dem || 0;
            const repVotes = result.us_house_rep || 0;
            const totalVotes = result.us_house_total || 0;
            
            const demPct = totalVotes > 0 ? (demVotes / totalVotes) * 100 : 0;
            const repPct = totalVotes > 0 ? (repVotes / totalVotes) * 100 : 0;
            const marginPct = Math.abs(demPct - repPct);
            const winner = demPct > repPct ? 'Democratic' : 'Republican';
            
            // Determine competitiveness
            let competitiveness;
            if (marginPct >= 40) {
              competitiveness = winner === 'Republican' ? 'Annihilation Republican' : 'Annihilation Democratic';
            } else if (marginPct >= 30) {
              competitiveness = winner === 'Republican' ? 'Dominant Republican' : 'Dominant Democratic';
            } else if (marginPct >= 20) {
              competitiveness = winner === 'Republican' ? 'Stronghold Republican' : 'Stronghold Democratic';
            } else if (marginPct >= 10) {
              competitiveness = winner === 'Republican' ? 'Safe Republican' : 'Safe Democratic';
            } else if (marginPct >= 5.5) {
              competitiveness = winner === 'Republican' ? 'Likely Republican' : 'Likely Democratic';
            } else if (marginPct >= 1) {
              competitiveness = winner === 'Republican' ? 'Lean Republican' : 'Lean Democratic';
            } else if (marginPct >= 0.5) {
              competitiveness = winner === 'Republican' ? 'Tilt Republican' : 'Tilt Democratic';
            } else {
              competitiveness = `Tossup (${winner} win)`;
            }
            let compColor = '#6b7280';
            if (competitiveness.includes('Rep')) {
              if (competitiveness.includes('Annihilation')) compColor = '#67000d';
              else if (competitiveness.includes('Dominant')) compColor = '#a50f15';
              else if (competitiveness.includes('Stronghold')) compColor = '#cb181d';
              else if (competitiveness.includes('Safe')) compColor = '#ef3b2c';
              else if (competitiveness.includes('Likely')) compColor = '#fb6a4a';
              else if (competitiveness.includes('Lean')) compColor = '#fcae91';
              else if (competitiveness.includes('Tilt')) compColor = '#fee8c8';
            } else if (competitiveness.includes('Dem')) {
              if (competitiveness.includes('Annihilation')) compColor = '#08306b';
              else if (competitiveness.includes('Dominant')) compColor = '#08519c';
              else if (competitiveness.includes('Stronghold')) compColor = '#3182bd';
              else if (competitiveness.includes('Safe')) compColor = '#6baed6';
              else if (competitiveness.includes('Likely')) compColor = '#9ecae1';
              else if (competitiveness.includes('Lean')) compColor = '#c6dbef';
              else if (competitiveness.includes('Tilt')) compColor = '#e1f5fe';
            }
            
            electionInfo = `
              <div style="margin-bottom: 16px;">
                <h5>üéØ Competitiveness</h5>
                <p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>
              </div>
              <div style="margin-bottom: 16px;">
                <h5>üìà Margin</h5>
                <p style="color: ${winner === 'Republican' ? '#dc2626' : '#1e40af'}; font-weight: bold; font-size: 18px;">
                  ${winner} +${marginPct.toFixed(1)}%
                </p>
              </div>
              <div style="margin-bottom: 16px;">
                <h5>üó≥Ô∏è Vote Breakdown</h5>
                <p><span style="color: #1e40af; font-weight: bold;">Democratic: </span>${demPct.toFixed(1)}% (${demVotes.toLocaleString()})</p>
                <p><span style="color: #dc2626; font-weight: bold;">Republican: </span>${repPct.toFixed(1)}% (${repVotes.toLocaleString()})</p>
                <p><strong>Total Votes:</strong> ${totalVotes.toLocaleString()}</p>
              </div>
            `;
          }
        }
      }
      
      contentEl.innerHTML = demographicInfo + electionInfo;
      detailsDiv.style.display = 'block';
    }

    function showStateDistrictDetails(districtNum, chamber) {
      const detailsDiv = document.getElementById('county-details');
      const nameEl = document.getElementById('county-name');
      const contentEl = document.getElementById('county-info-content');
      
      const title = chamber === 'house' ? `State House District ${districtNum}` : `State Senate District ${districtNum}`;
      nameEl.textContent = title;
      
      // Get district info from appropriate CSV
      const districtInfo = chamber === 'house' 
        ? stateHouseInfo?.find(d => d.district == districtNum)
        : stateSenateInfo?.find(d => d.district == districtNum);
      
      let demographicInfo = '';
      if (districtInfo) {
        demographicInfo = `
          <div style="margin-bottom: 16px;">
            <h5>üë• Demographics (VAP)</h5>
            <p><strong>Total Population:</strong> ${districtInfo.total_population.toLocaleString()}</p>
            <p><strong>White:</strong> ${districtInfo.white_vap_pct}%</p>
            <p><strong>Black:</strong> ${districtInfo.black_vap_pct}%</p>
            <p><strong>Hispanic:</strong> ${districtInfo.hispanic_vap_pct}%</p>
          </div>
        `;
      }
      
      // Get current contest results if available
      const contestValue = document.getElementById('contestSelect').value;
      let electionInfo = '';
      
      if (contestValue && electionData) {
        const [contestType, year] = contestValue.split('_');
        const expectedType = chamber === 'house' ? 'state_house' : 'state_senate';
        
        if (contestType === expectedType) {
          // For state legislative districts, we need to aggregate county data by district
          // This is complex without a county-to-district mapping, so show general message
          electionInfo = `
            <div style="margin-bottom: 16px;">
              <h5>üìä ${year} ${chamber === 'house' ? 'State House' : 'State Senate'}</h5>
              <p style="color: #666; font-style: italic;">District-level results require county-to-district mapping. 
              Click to see general trends for this contest type.</p>
            </div>
          `;
        }
      }
      
      contentEl.innerHTML = demographicInfo + electionInfo;
      detailsDiv.style.display = 'block';
    }

    function getStateDistrictTrends(districtNum, chamber) {
      // For state legislative districts, we'll show recent election years
      const recentYears = [2024, 2022, 2020, 2018, 2016];
      const trends = [];
      
      // This is simplified - in reality you'd need county-to-district mapping
      // For now, just show that data is available
      recentYears.forEach(year => {
        const contestType = chamber === 'house' ? 'state_house' : 'state_senate';
        const hasData = electionData.some(row => 
          row.year == year && row[`${contestType}_total`] > 0
        );
        
        if (hasData) {
          trends.push({
            year: year,
            display: `${year}: Data Available`,
            margin: 0,
            type: contestType
          });
        }
      });
      
      if (trends.length === 0) {
        trends.push({
          year: 0,
          display: 'District mapping needed',
          margin: 0,
          type: 'info'
        });
      }
      
      return trends;
    }

    // Quick info functions for hover tooltips
    function getQuickCountyInfo(countyName) {
      // Find the most recent presidential election data
      const recent = electionData
  .filter(row => normalizeCountyName(row.county) === normalizeCountyName(countyName) && row.president_total > 0)
        .sort((a, b) => b.year - a.year)[0];
      
      if (recent) {
        const demPct = (recent.president_dem / recent.president_total) * 100;
        const repPct = (recent.president_rep / recent.president_total) * 100;
        const margin = demPct - repPct;
        const winner = margin > 0 ? 'D' : 'R';
        const marginAbs = Math.abs(margin);
        
        return `<div class="quick-tooltip">
          <strong>${countyName} County</strong><br>
          ${recent.year}: ${winner}+${marginAbs.toFixed(1)}%<br>
          <em>Click for full trends</em>
        </div>`;
      }
      
      return `<div class="quick-tooltip">
        <strong>${countyName} County</strong><br>
        <em>Click for details</em>
      </div>`;
    }

    function getQuickDistrictInfo(districtNum, type) {
      let displayName = '';
      let recent = null;
      
      if (type === 'congressional') {
        displayName = `Congressional District ${districtNum}`;
        recent = congressionalData
          .filter(row => row.district == districtNum && row.us_house_total > 0)
          .sort((a, b) => b.year - a.year)[0];
          
        if (recent) {
          const demPct = (recent.us_house_dem / recent.us_house_total) * 100;
          const repPct = (recent.us_house_rep / recent.us_house_total) * 100;
          const margin = demPct - repPct;
          const winner = margin > 0 ? 'D' : 'R';
          const marginAbs = Math.abs(margin);
          
          return `<div class="quick-tooltip">
            <strong>${displayName}</strong><br>
            ${recent.year}: ${winner}+${marginAbs.toFixed(1)}%<br>
            <em>Click for full trends</em>
          </div>`;
        }
      } else if (type === 'house') {
        displayName = `State House District ${districtNum}`;
      } else if (type === 'senate') {
        displayName = `State Senate District ${districtNum}`;
      }
      
      return `<div class="quick-tooltip">
        <strong>${displayName}</strong><br>
        <em>Click for details</em>
      </div>`;
    }

    async function init() {
  await loadFipsToCountyName();
  try {
    setStatus('Loading counties...');
    console.log('Loading counties from:', CONFIG.paths.counties);
    const counties = await loadJSON(CONFIG.paths.counties);
    console.log('Counties loaded successfully:', counties.features?.length, 'features');
    map.addSource('counties', { type: 'geojson', data: counties });
    countyNameMap = buildCountyNameMapFromGeoJSON(counties);
    console.log('County name map built:', Object.keys(countyNameMap).length, 'counties');
    // Add initial county layers
    addCountyLayers();
    setStatus('Counties loaded');

    setStatus('Loading election data...');
    console.log('Loading election data from:', CONFIG.paths.election);
    try {
      electionData = await loadJSON(CONFIG.paths.election);
      setStatus('Election data loaded');
      console.log('Election data loaded:', electionData);
    } catch (e) {
      setStatus('Failed to load election data: ' + e.message);
      document.getElementById('contestSelect').innerHTML = '<option value="">Election data failed to load</option>';
      return;
    }
    // Skipping congressional and district CSV loading (removed obsolete CSV logic)
    populateContestSelectFromElectionJSON(electionData);
    map.fitBounds(CONFIG.fitBounds, { padding: 20 });
  } catch (e) {
    setStatus('Error: ' + e.message);
    document.getElementById('contestSelect').innerHTML = '<option value="">Error loading map data</option>';
  }
}

    function getCountyAggregates(results) {
      const agg = {};
      Object.values(results || {}).forEach(r => {
        const countyKey = (r.county || '').toString().trim();
        if (!countyKey) return;
        if (!agg[countyKey]) agg[countyKey] = { dem:0, rep:0, total:0 };
        agg[countyKey].dem += (r.dem_votes||0);
        agg[countyKey].rep += (r.rep_votes||0);
        agg[countyKey].total += (r.total_votes||0);
      });
      return agg;
    }

// Minimal function to display statewide results summary
function updateStatewideResults(contestType, year, demVotes, repVotes, totalVotes) {
  const el = document.getElementById('statewide');
  if (!el) return;
  el.textContent = `MO ${formatContestName(contestType, year)} (${year}) ‚Äî D: ${demVotes.toLocaleString()} | R: ${repVotes.toLocaleString()} | Total: ${totalVotes.toLocaleString()}`;
}

    function categoryColorForMargin(marginPct, winner) {
      // NC map criteria: exact same thresholds and colors
      if (marginPct >= 40) {
        return winner === 'R' ? '#67000d' : '#08306b'; // Annihilation
      } else if (marginPct >= 30) {
        return winner === 'R' ? '#a50f15' : '#08519c'; // Dominant
      } else if (marginPct >= 20) {
        return winner === 'R' ? '#cb181d' : '#3182bd'; // Stronghold
      } else if (marginPct >= 10) {
        return winner === 'R' ? '#ef3b2c' : '#6baed6'; // Safe
      } else if (marginPct >= 5.5) {
        return winner === 'R' ? '#fb6a4a' : '#9ecae1'; // Likely
      } else if (marginPct >= 1) {
        return winner === 'R' ? '#fcae91' : '#c6dbef'; // Lean
      } else if (marginPct >= 0.5) {
        return winner === 'R' ? '#fee8c8' : '#e1f5fe'; // Tilt
      } else {
        return '#f7f7f7'; // Tossup
      }
    }

    function applyContest(contestKey) {
      if (!contestKey) return setStatus('Select a contest');
      
      // Split contest key properly - year is always the last part after final underscore
      const lastUnderscoreIndex = contestKey.lastIndexOf('_');
      const contestType = contestKey.substring(0, lastUnderscoreIndex);
      const year = contestKey.substring(lastUnderscoreIndex + 1);
      
      if (currentView === 'counties') {
        applyCountyContest(contestType, year);
      } else if (currentView === 'districts' && contestType === 'us_house') {
        // US House races use district-specific data
        applyDistrictContest(contestType, year);
      } else {
        // All other contests (statewide) aggregate county data by district
        applyStatewideContestToDistricts(contestType, year);
      }
    }

    function applyCountyContest(contestType, year) {
  // Updated logic for nested results_by_year[year][contest] structure
  const resultsByYear = electionData.results_by_year || {};
  if (!resultsByYear[year] || !resultsByYear[year][contestType]) {
    setStatus('No data for contest ' + contestType);
    return;
  }
  const countiesObj = resultsByYear[year][contestType];
  // countiesObj is an object: { countyName: { ...data... }, ... }
  const contestData = Object.values(countiesObj);
  console.log(`Applying ${contestType} for ${year}:`, contestData.length, 'counties found');
  if (contestData.length === 0) {
    return setStatus('No data found for this contest');
  }
  // Store current results for county details using normalized county names
  function normalizeCountyName(name) {
    return (name || '')
      .replace(/^saint /i, 'st ')
      .replace(/^st\.? /i, 'st ')
      .replace(/\bsaint\b/gi, 'st')
      .replace(/\bst\.?\b/gi, 'st')
      .replace(/[^a-z0-9 ]/gi, '')
      .replace(/\s+/g, ' ')
      .trim()
      .toUpperCase();
  }
  currentElectionResults = {};
  contestData.forEach(row => {
    const norm = normalizeCountyName(row.county);
    currentElectionResults[norm] = row;
  });
  // Calculate statewide totals
  let statewideDemVotes = 0;
  let statewideRepVotes = 0;
  let statewideTotalVotes = 0;
  contestData.forEach(row => {
    statewideDemVotes += row.dem_votes || 0;
    statewideRepVotes += row.rep_votes || 0;
    statewideTotalVotes += row.total_votes || 0;
  });
  // Update statewide results display
  updateStatewideResults(contestType, year, statewideDemVotes, statewideRepVotes, statewideTotalVotes);
  // Build expression for county coloring using normalized, uppercase names
  const expr = ['case'];
  let countiesProcessed = 0;
  contestData.forEach(row => {
    const countyName = normalizeCountyName(row.county);
    const demVotes = row.dem_votes || 0;
    const repVotes = row.rep_votes || 0;
    const totalVotes = row.total_votes || 0;
    if (totalVotes === 0) return;
    const demPct = (demVotes / totalVotes) * 100;
    const repPct = (repVotes / totalVotes) * 100;
    const winner = repPct > demPct ? 'R' : 'D';
    const marginPct = Math.abs(repPct - demPct);
    const color = categoryColorForMargin(marginPct, winner);
    // Match on normalized, uppercase name from GeoJSON
    expr.push(['==', ['upcase', ['get', 'NAME20']], countyName]);
    expr.push(color);
    countiesProcessed++;
  });
  expr.push('#e0e0e0'); // default color
  console.log(`Color expression built for ${countiesProcessed} counties`);
  map.setPaintProperty('county-fill', 'fill-color', expr);
  document.getElementById('statewide').textContent = `MO ${formatContestName(contestType, year)} (${year})`;
  setStatus(`Applied contest: ${formatContestName(contestType, year)} ${year}`);
    }

    function applyDistrictContest(contestType, year) {
      if (contestType !== 'us_house') {
        return setStatus('Only US House races available for congressional districts');
      }
      
      // Filter congressional data for this year
      const contestData = congressionalData.filter(row => row.year == year);
      
      if (contestData.length === 0) {
        return setStatus('No congressional data found for this year');
      }

      // Build expression for district coloring
      const expr = ['case'];
      
      contestData.forEach(row => {
        const district = row.district;
        const demVotes = row.us_house_dem || 0;
        const repVotes = row.us_house_rep || 0;
        const totalVotes = row.us_house_total || 0;
        
        if (totalVotes === 0) return;
        
        const demPct = (demVotes / totalVotes) * 100;
        const repPct = (repVotes / totalVotes) * 100;
        const winner = repPct > demPct ? 'R' : 'D';
        const marginPct = Math.abs(repPct - demPct);
        const color = categoryColorForMargin(marginPct, winner);
        
        expr.push(['==', ['get', 'DISTRICT'], district]);
        expr.push(color);
      });
      
      expr.push('#e0e0e0'); // default color
      
      map.setPaintProperty('district-fill', 'fill-color', expr);
  document.getElementById('statewide').textContent = `MO US House (${year})`;
  setStatus(`Applied contest: MO US House ${year}`);
    }

    function applyStatewideContestToDistricts(contestType, year) {
      // For statewide contests in district views, we need to aggregate county data by district
      const contestData = electionData.filter(row => row.year == year);

      if (contestData.length === 0) {
        return setStatus('No data found for this contest');
      }

      // Calculate statewide totals for this contest
      let totalDem = 0;
      let totalRep = 0;
      let totalVotes = 0;

      contestData.forEach(row => {
        const demVotes = Number(row[`${contestType}_dem`]) || 0;
        const repVotes = Number(row[`${contestType}_rep`]) || 0;
        const rowTotalVotes = Number(row[`${contestType}_total`]);
        if (!isNaN(rowTotalVotes) && rowTotalVotes > 0) {
          totalVotes += rowTotalVotes;
        } else {
          totalVotes += demVotes + repVotes;
        }
        totalDem += demVotes;
        totalRep += repVotes;
      });

      if (totalVotes === 0) {
        return setStatus(`No data found for ${contestType} in ${year}`);
      }

      const demPct = (totalDem / totalVotes) * 100;
      const repPct = (totalRep / totalVotes) * 100;
      const winner = repPct > demPct ? 'R' : 'D';
      const marginPct = Math.abs(repPct - demPct);
      const color = categoryColorForMargin(marginPct, winner);

      // Apply uniform color to all districts (showing statewide result)
      const layerName = currentView === 'districts' ? 'district-fill' : 
                       currentView === 'state_house' ? 'state-house-fill' : 'state-senate-fill';

      if (map.getLayer(layerName)) {
        map.setPaintProperty(layerName, 'fill-color', color);
      } else {
        setStatus('District layer not found!', 5000, true);
      }

  document.getElementById('statewide').textContent = `MO ${formatContestName(contestType, year)} (${year}) - Statewide Result`;
      setStatus(`Applied statewide contest: ${formatContestName(contestType, year)} ${year} (${demPct.toFixed(1)}% D, ${repPct.toFixed(1)}% R)`);
    }

    window.onload = init;
// Floating sidebar expand button logic
document.addEventListener('DOMContentLoaded', function() {
  const floatBtn = document.getElementById('sidebar-float-toggle');
  if (floatBtn) {
    floatBtn.onclick = function() {
      toggleSidebar();
    };
  }
  // Hide float button if sidebar is open on load
  const sidebar = document.getElementById('sidebar');
  if (sidebar && !sidebar.classList.contains('minimized')) {
    floatBtn.style.display = 'none';
  }
  // Status panel close button
  const statusExit = document.getElementById('status-exit');
  if (statusExit) {
    statusExit.onclick = function() {
      document.getElementById('status-panel').style.display = 'none';
    };
  }
});
  </script>
</body>
</html>

